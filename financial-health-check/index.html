<!doctype html>
<html lang="id">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Personal/Family Financial Health Check</title>
  <style>
    :root{
      --bg:#f6f7fb; --card:#fff; --border:#e7e7ef; --muted:#616161;
      --primary:#0b63f6; --soft:#eef2ff; --danger:#b42318; --ok:#067647; --warn:#8a5b00;
      --r:14px; --gap:12px;
      --fs-body:14px; --fs-small:12px; --fs-h1:20px; --fs-h2:16px; --fs-h3:14px;
    }
    *{ box-sizing:border-box; }
    body{
      font-family: system-ui, -apple-system, Segoe UI, Roboto, Arial, sans-serif;
      margin:0; background:var(--bg); color:#111; font-size:var(--fs-body); line-height:1.5;
    }
    .wrap{ max-width: 980px; margin:0 auto; padding:18px 18px 90px; } /* bottom padding for action bar */
    .card{
      background:var(--card); border:1px solid var(--border); border-radius: var(--r);
      padding:16px; box-shadow: 0 1px 0 rgba(0,0,0,.03);
    }
    h1{ font-size: var(--fs-h1); margin:0 0 6px; line-height:1.25; }
    h2{ font-size: var(--fs-h2); margin: 18px 0 10px; line-height:1.25; }
    h3{ font-size: var(--fs-h3); margin: 14px 0 8px; line-height:1.25; }
    .muted{ color:var(--muted); font-size:var(--fs-body); }
    .small{ color:var(--muted); font-size:var(--fs-small); line-height:1.45; }
    .hr{ height:1px; background:#eee; margin: 14px 0; }

    label{ display:block; font-size:var(--fs-small); color:#333; margin-bottom:6px; }
    input, select, textarea{
      width:100%; padding: 10px 12px; border:1px solid #d9d9e6; border-radius: 10px;
      font-size:var(--fs-body); background:#fff;
    }
    textarea{ min-height: 70px; resize: vertical; }

    .twrap{ overflow:auto; border:1px solid #eee; border-radius: 12px; }
    table{ width:100%; border-collapse: collapse; min-width: 780px; }
    th, td{ padding: 10px; border-bottom:1px solid #eee; font-size:var(--fs-body); vertical-align:middle; }
    th{
      font-size:var(--fs-small); color:#555; text-transform: uppercase; letter-spacing:.04em;
      background:#fbfbfe;
    }

    /* --- NO "Aksi" column: only 3 columns now --- */
    .namecol{ width: 56%; }
    .percol{ width: 160px; }
    .num{ text-align:right; width: 240px; }

    .subtotal{ background:#fafafe; font-weight:800; }
    .addrow{ background:#fff; }
    .addrow td{ border-bottom:0; }

    .btn{
      border:0; border-radius: 12px; padding: 9px 12px; font-weight: 800; cursor:pointer;
      background: var(--soft); color: var(--primary); font-size: var(--fs-body);
    }
    .btn.primary{ background: var(--primary); color:#fff; }
    .btn.danger{ background:#ffecec; color: var(--danger); }
    .btn.small{ padding: 7px 10px; border-radius: 10px; font-size: var(--fs-small); }
    .btn.icon{ width:34px; height:34px; padding:0; display:inline-flex; align-items:center; justify-content:center; border-radius:10px; }

    .pill{ display:inline-block; padding: 4px 10px; border-radius: 999px; font-size: var(--fs-small); font-weight: 900; }
    .pill.red{ background:#ffe1e1; color:var(--danger); }
    .pill.yellow{ background:#fff1cc; color:var(--warn); }
    .pill.green{ background:#d7ffe3; color:var(--ok); }
    .pill.gray{ background:#eee; color:#333; }

    details{ background:#fafafe; border:1px solid #ececf6; padding: 10px 12px; border-radius: 12px; }
    summary{ cursor:pointer; font-weight:900; font-size:var(--fs-body); }

    .row2{ display:grid; grid-template-columns: 1fr; gap: var(--gap); }
    @media (min-width: 780px){ .row2{ grid-template-columns: 1fr 1fr; } }

    .hint{ background:#f9fbff; border:1px dashed #d8e3ff; padding:10px 12px; border-radius:12px; }

    .block{
      border:1px solid #ececf6; background:#fff; border-radius:12px; padding:12px;
    }
    .kpiTitle{ font-weight:900; }
    .kpiText{ margin-top:4px; }

    .tag{
      display:inline-block; padding:2px 8px; border-radius:999px; font-size:var(--fs-small); font-weight:900;
      background:#f2f2f7; color:#333;
    }
    .tag.red{ background:#ffe1e1; color:var(--danger); }
    .tag.yellow{ background:#fff1cc; color:var(--warn); }
    .tag.green{ background:#d7ffe3; color:var(--ok); }

    /* --- Page layout (always vertical) --- */
    .page{ margin-top: 14px; }
    .pageHeader{ display:flex; justify-content:space-between; align-items:flex-end; gap:10px; }
    .pageNum{ font-weight:900; color:#333; font-size: var(--fs-small); }

    /* --- Custom row UI (remove button in item cell) --- */
    .itemRow{
      display:flex; align-items:center; gap:10px;
    }
    .itemRow .itemGrow{ flex:1; min-width:0; }
    .itemRow .rmWrap{ flex:0 0 auto; }

    /* ===============================
       MOBILE: no horizontal scroll
       Table becomes stacked cards
       =============================== */
       @media (max-width: 820px){
  .wrap{ padding:12px 12px 96px; }
  .twrap{ overflow: visible; border:0; }

  table{ min-width: 0 !important; } /* remove min width */
  thead{ display:none; }

  table, tbody, tr, td{ display:block; width:100%; }
  tr{ border:1px solid #eee; border-radius:12px; margin:10px 0; overflow:hidden; background:#fff; }
  td{ border-bottom:1px solid #f1f1f1; padding:10px 12px; }

  td[data-label]{
    display:flex;
    gap:10px;
    align-items:flex-start;
    justify-content:space-between;
  }
  td[data-label]::before{
    content: attr(data-label);
    font-size: var(--fs-small);
    color: #555;
    font-weight: 800;
    text-transform: uppercase;
    letter-spacing: .03em;
    flex: 0 0 34%;
    padding-top: 3px;
  }

  .itemRow{ width:100%; }
  .itemRow .rmWrap{ margin-top:2px; }
  .btn.icon{ width:32px; height:32px; }

  tr.subtotalRow{ background:#fafafe; border-style: dashed; }
  tr.addRowCard{ border-style: dashed; background:#fff; }
  tr.addRowCard td{ border-bottom:0; }

  /* === FIX: dropdown periode kepotong === */
  td[data-label]{
    justify-content: flex-start; /* override space-between */
  }

  td[data-label] > input,
  td[data-label] > select,
  td[data-label] > textarea{
    width: auto;        /* override width:100% global */
    flex: 1 1 auto;
    min-width: 170px;   /* biar "Bulanan/Tahunan" muat */
  }

  /* opsional: kecilkan porsi label kiri */
  td[data-label]::before{
    flex: 0 0 28%;
  }
}

    /* ===============================
       OUTPUT TABLES: column sizing
       =============================== */
    .tbl-2col, .tbl-2col-wideNum, .tbl-3col{ table-layout: fixed; width:100%; min-width: 0; }
    .tbl-2col col:first-child{ width: 68%; }
    .tbl-2col col:last-child{ width: 32%; }
    .tbl-2col-wideNum col:first-child{ width: 62%; }
    .tbl-2col-wideNum col:last-child{ width: 38%; }
    .tbl-3col col:nth-child(1){ width: 22%; }
    .tbl-3col col:nth-child(2){ width: 18%; }
    .tbl-3col col:nth-child(3){ width: 60%; }
    .rightNum{ text-align:right; white-space:nowrap; }

    /* --- Bottom action bar --- */
    .actionBar{
      position: fixed;
      left: 0; right: 0; bottom: 0;
      background: rgba(246,247,251,.92);
      border-top: 1px solid #e8e8f1;
      backdrop-filter: blur(6px);
      -webkit-backdrop-filter: blur(6px);
      padding: 10px 12px;
      z-index: 50;
    }
    .actionInner{
      max-width: 980px;
      margin: 0 auto;
      display:flex;
      gap:10px;
      flex-wrap: wrap;
      justify-content: flex-end;
      align-items: center;
    }
    .actionHint{
      margin-right:auto;
      color: var(--muted);
      font-size: var(--fs-small);
    }
    @media (max-width: 560px){
      .actionInner{ justify-content: space-between; }
      .actionHint{ width:100%; margin-right:0; }
      .actionInner .btn{ flex: 1 1 auto; }
    }

    /* ---- Print styles for PDF ---- */
    @page { size: A4; margin: 12mm; }

    @media print{
      body{ background:#fff; }
      .wrap{ max-width: 100%; padding:0; }
      .no-print, .actionBar{ display:none !important; }
      .card{ border:0; box-shadow:none; padding:0; }
      .twrap{ overflow: visible !important; border:0 !important; }
      table{ min-width: 0 !important; width:100% !important; table-layout: fixed !important; }
      thead{ display: table-header-group !important; }
      th{ background:#f2f2f2 !important; -webkit-print-color-adjust: exact; print-color-adjust: exact; }
      .subtotal{ background:#f2f2f2 !important; -webkit-print-color-adjust: exact; print-color-adjust: exact; }
      details{ border:0; background:#fff; padding:0; }
      summary{ list-style:none; }
      details > summary::-webkit-details-marker { display:none; }

      /* tighter typography for A4 */
      th, td{ padding: 7px 8px !important; font-size: 11px !important; }
      h1{ font-size: 16px !important; }
      h2{ font-size: 13px !important; margin: 10px 0 8px !important; }
      h3{ font-size: 12px !important; margin: 10px 0 6px !important; }
      .small{ font-size: 10px !important; }
      .muted{ font-size: 11px !important; }

      /* force normal table layout even if mobile rules exist */
      table{ display: table !important; }
      tbody{ display: table-row-group !important; }
      tr{ display: table-row !important; border:0 !important; margin:0 !important; border-radius:0 !important; }
      td, th{ display: table-cell !important; }
      td[data-label]::before{ content: "" !important; }

      /* prevent numbers being cut */
      .rightNum, .num{ white-space: nowrap !important; }
      td, th{ overflow-wrap: break-word !important; word-wrap: break-word !important; overflow: hidden !important; }

      /* 12 pages mapping */
      .print-page{ page-break-after: always; break-after: page; }
      .print-page:last-child{ page-break-after: auto; break-after: auto; }

      /* hide "Tambah baris" row in print */
      .print-hide{ display:none !important; }

      .byline{
    font-size: 11px !important;
    margin-top: 2px !important;
  }
  .byline .social{
    display:none; /* biar PDF lebih bersih */
  } 

    }

    /* Screen-only separator between pages */
.page-sep {
  height: 18px;
  margin: 24px 0;
  border-radius: 999px;
  background: #707070;
}
@media print{
  .page-sep{ display:none !important; } /* jangan ikut ke PDF */
}

/* ===== Header identity ===== */
.header{
  display:flex;
  justify-content: space-between;
  align-items:flex-start;
  gap:12px;
}

.byline{
  margin-top:4px;
  font-size: 13px;
  color: var(--muted);
}

.byline b{
  color:#111;
}

.byline .social a{
  color: var(--primary);
  text-decoration: none;
  font-weight: 600;
}

.byline .social a:hover{
  text-decoration: underline;
}

/* Mobile: stack nicely */
@media (max-width: 560px){
  .header{
    flex-direction: column;
  }
}


  </style>
</head>

<body>
<div class="wrap">
  <div class="card">

    <div class="header">
      <div>
        <h1>Personal/Family Financial Health Check</h1>
        <div class="byline">
          by <b>Dendra Falah, CFP®</b>
          <span class="social">
            ·
            <a href="https://www.linkedin.com/in/dendrafalah/" target="_blank" rel="noopener">LinkedIn</a>
            ·
            <a href="https://www.instagram.com/dendrafalah/" target="_blank" rel="noopener">Instagram</a>
          </span>
        </div>
        <div class="muted">
          Silakan mengisi angka dengan estimasi terbaik. Untuk setiap item, pilih periode
          <b>Bulanan</b> atau <b>Tahunan</b>.
        </div>
      </div>
    </div>

    <div class="hr"></div>

    <!-- =======================
         PAGE 1: PROFILE
         ======================= -->
    <section class="page print-page" id="page_profile">
      <div class="pageHeader">
        <h2 style="margin:0;">Page 1 — Profil</h2>
      </div>
      <div class="hr"></div>

      <h3>1) Profil Singkat</h3>
      <div class="row2">
        <div>
          <label>Nama / Inisial</label>
          <input id="pf_name" placeholder="Contoh: John Doe" />
        </div>
        <div>
          <label>Status</label>
          <select id="pf_status">
            <option value="single">Single</option>
            <option value="married">Menikah</option>
            <option value="married_kids">Menikah + Anak</option>
          </select>
        </div>
      </div>

      <div class="row2" style="margin-top:12px;">
        <div>
          <label>Tanggungan (jumlah orang)</label>
          <input id="pf_dependents" inputmode="numeric" placeholder="0" />
        </div>
        <div>
          <label>Target Dana Darurat</label>
          <select id="pf_ef_target">
            <option value="1">1 bulan</option>
            <option value="3" selected>3 bulan</option>
            <option value="6">6 bulan</option>
            <option value="9">9 bulan</option>
            <option value="12">12 bulan</option>
          </select>
        </div>
      </div>

      <details style="margin-top:12px;">
        <summary>Opsional: Catatan untuk Konsultasi 1-on-1</summary>
        <div class="row2" style="margin-top:10px;">
          <div>
            <label>Isu utama yang dirasakan</label>
            <textarea id="pf_worry" placeholder="Contoh: cashflow sering defisit; cicilan; sulit konsisten menabung."></textarea>
          </div>
          <div>
            <label>Rencana/peristiwa 12 bulan ke depan</label>
            <textarea id="pf_next12m" placeholder="Contoh: pindah rumah; menikah; ganti pekerjaan; rencana pendidikan."></textarea>
          </div>
        </div>
      </details>

      <div class="hr"></div>
      <div class="hint small">
        <b>Catatan:</b> Halaman berikutnya berisi input angka per kategori. Anda bisa menambahkan item lain yang belum ada.
      </div>
    </section>

    <div class="page-sep no-print" aria-hidden="true"></div>

    <!-- =======================
         PAGES 2–7: INPUT SECTIONS
         ======================= -->
    <section class="page print-page" id="page_income">
      <div class="pageHeader">
        <h2 style="margin:0;">Page 2 — Income</h2>
      </div>
      <div class="hr"></div>
      <div id="sec_mount_income"></div>
    </section>

    <div class="page-sep no-print" aria-hidden="true"></div>

    <section class="page print-page" id="page_needs">
      <div class="pageHeader">
        <h2 style="margin:0;">Page 3 — Needs</h2>
      </div>
      <div class="hr"></div>
      <div id="sec_mount_needs"></div>
    </section>

    <div class="page-sep no-print" aria-hidden="true"></div>

    <section class="page print-page" id="page_lifestyle">
      <div class="pageHeader">
        <h2 style="margin:0;">Page 4 — Lifestyle</h2>
      </div>
      <div class="hr"></div>
      <div id="sec_mount_lifestyle"></div>
    </section>

    <div class="page-sep no-print" aria-hidden="true"></div>

    <section class="page print-page" id="page_commit">
      <div class="pageHeader">
        <h2 style="margin:0;">Page 5 — Commitments & Allocations</h2>
      </div>
      <div class="hr"></div>
      <div id="sec_mount_commit"></div>
    </section>

    <div class="page-sep no-print" aria-hidden="true"></div>

    <section class="page print-page" id="page_assets">
      <div class="pageHeader">
        <h2 style="margin:0;">Page 6 — Assets</h2>
      </div>
      <div class="hr"></div>
      <div id="sec_mount_assets"></div>
    </section>

    <div class="page-sep no-print" aria-hidden="true"></div>

    <section class="page print-page" id="page_liabilities">
      <div class="pageHeader">
        <h2 style="margin:0;">Page 7 — Liabilities</h2>
      </div>
      <div class="hr"></div>
      <div id="sec_mount_liabilities"></div>
    </section>

    <div class="page-sep no-print" aria-hidden="true"></div>

    <!-- =======================
         PAGES 8–9: HEALTH CHECK
         ======================= -->
    <section class="page print-page" id="page_health_1">
      <div class="pageHeader">
        <h2 style="margin:0;">Page 8 — Hasil Health Check (Ringkasan)</h2>
      </div>
      <div class="hr"></div>

      <div style="display:flex; gap:10px; align-items:center; flex-wrap:wrap;">
        <span class="pill gray" id="pill_overall">-</span>
        <div class="muted" id="overall_text">Silakan isi data, lalu lihat ringkasan hasilnya.</div>
      </div>

      <div class="hr"></div>

      <table class="tbl-2col-wideNum">
        <colgroup><col/><col/></colgroup>
        <thead><tr><th>Indikator Utama</th><th>Nilai (Bulanan)</th></tr></thead>
        <tbody>
          <tr>
            <td><b>Total Income</b><div class="small">Pemasukan ekuivalen bulanan (tahunan ÷ 12).</div></td>
            <td id="k_income" class="rightNum">-</td>
          </tr>
          <tr>
            <td><b>Living Expenses (Needs + Lifestyle)</b><div class="small">Biaya hidup ekuivalen bulanan.</div></td>
            <td id="k_living" class="rightNum">-</td>
          </tr>
          <tr>
            <td><b>Debt Payment</b><div class="small">Cicilan ekuivalen bulanan.</div></td>
            <td id="k_debtpay" class="rightNum">-</td>
          </tr>
          <tr>
            <td><b>Saving + Invest</b><div class="small">Tabungan + investasi ekuivalen bulanan.</div></td>
            <td id="k_saveinvest" class="rightNum">-</td>
          </tr>
          <tr>
            <td><b>True Cash Left</b><div class="small">Sisa kas setelah living + cicilan + proteksi + saving/invest + komitmen lain.</div></td>
            <td id="k_cashleft" class="rightNum"><b>-</b></td>
          </tr>
          <tr>
            <td><b>Emergency Buffer</b><div class="small">Bulan kebutuhan pokok (basis Needs) yang dapat ditutup dana likuid.</div></td>
            <td id="k_ef" class="rightNum">-</td>
          </tr>
          <tr>
            <td><b>Net Worth</b><div class="small">Total aset – total sisa pokok utang (snapshot).</div></td>
            <td id="k_nw" class="rightNum">-</td>
          </tr>
        </tbody>
      </table>

      <div class="hr"></div>

      <h3 style="margin:0 0 8px;">Interpretasi Kondisi (overview)</h3>
      <div class="block" id="detail_overview"><div class="small">—</div></div>

      <div class="hr"></div>

      <h3 style="margin:0 0 8px;">Key Ratios</h3>
      <table class="tbl-3col">
        <colgroup><col/><col/><col/></colgroup>
        <thead><tr><th>Rasio</th><th>Nilai</th><th>Interpretasi</th></tr></thead>
        <tbody>
          <tr>
            <td><b>Saving rate</b></td>
            <td id="r_save" class="rightNum">-</td>
            <td class="small">Proporsi income untuk tabungan + investasi. Patokan: ≥10% (awal), 15–25% (baik).</td>
          </tr>
          <tr>
            <td><b>Debt ratio</b></td>
            <td id="r_debt" class="rightNum">-</td>
            <td class="small">Proporsi income untuk cicilan. Patokan: ≤30–35% cenderung lebih aman.</td>
          </tr>
          <tr>
            <td><b>Liquidity months</b></td>
            <td id="r_liq" class="rightNum">-</td>
            <td class="small">Kemampuan dana likuid menutup biaya penting (living + cicilan + premi).</td>
          </tr>
        </tbody>
      </table>
    </section>

    <div class="page-sep no-print" aria-hidden="true"></div>

    <section class="page print-page" id="page_health_2">
      <div class="pageHeader">
        <h2 style="margin:0;">Page 9 — Hasil Health Check (Detail)</h2>
      </div>
      <div class="hr"></div>

      <div style="display:grid; grid-template-columns: 1fr; gap:10px;">
        <div class="block" id="detail_cashflow"><div class="kpiTitle">A. Stabilitas Arus Kas</div><div class="small kpiText">—</div></div>
        <div class="block" id="detail_spending"><div class="kpiTitle">B. Struktur Pengeluaran</div><div class="small kpiText">—</div></div>
        <div class="block" id="detail_debt"><div class="kpiTitle">C. Beban Cicilan</div><div class="small kpiText">—</div></div>
        <div class="block" id="detail_saving"><div class="kpiTitle">D. Kapasitas Menabung & Investasi</div><div class="small kpiText">—</div></div>
        <div class="block" id="detail_ef"><div class="kpiTitle">E. Dana Darurat & Likuiditas</div><div class="small kpiText">—</div></div>
        <div class="block" id="detail_balance"><div class="kpiTitle">F. Posisi Kekayaan Bersih</div><div class="small kpiText">—</div></div>
      </div>
    </section>

    <div class="page-sep no-print" aria-hidden="true"></div>

    <!-- =======================
         PAGE 10: IS + CF
         ======================= -->
    <section class="page print-page" id="page_is_cf">
      <div class="pageHeader">
        <h2 style="margin:0;">Page 10 — Income Statement & Cashflow</h2>
      </div>
      <div class="hr"></div>

      <h3 style="margin:0 0 8px;">1) Personal Income Statement (bulanan)</h3>
      <div class="small">
        Struktur pemasukan dan beban rutin, serta surplus/defisit sebelum saving+invest (semua tahunan dihitung ÷ 12).
      </div>
      <div class="hr"></div>

      <table class="tbl-3col">
        <colgroup><col/><col/><col/></colgroup>
        <thead><tr><th>Item</th><th>Jumlah</th><th>% Income</th></tr></thead>
        <tbody>
          <tr><td><b>Total Income</b></td><td id="is_income" class="rightNum">-</td><td id="is_income_pct" class="rightNum">-</td></tr>
          <tr><td>Needs</td><td id="is_needs" class="rightNum">-</td><td id="is_needs_pct" class="rightNum">-</td></tr>
          <tr><td>Lifestyle</td><td id="is_life" class="rightNum">-</td><td id="is_life_pct" class="rightNum">-</td></tr>
          <tr><td><b>Living Expenses</b></td><td id="is_living" class="rightNum">-</td><td id="is_living_pct" class="rightNum">-</td></tr>
          <tr><td>Debt payments</td><td id="is_debt" class="rightNum">-</td><td id="is_debt_pct" class="rightNum">-</td></tr>
          <tr><td>Premiums (proteksi)</td><td id="is_prem" class="rightNum">-</td><td id="is_prem_pct" class="rightNum">-</td></tr>
          <tr><td><b>Net (sebelum saving+invest)</b></td><td id="is_net" class="rightNum">-</td><td id="is_net_pct" class="rightNum">-</td></tr>
          <tr><td>Saving allocation</td><td id="is_save" class="rightNum">-</td><td id="is_save_pct" class="rightNum">-</td></tr>
          <tr><td>Invest allocation</td><td id="is_inv" class="rightNum">-</td><td id="is_inv_pct" class="rightNum">-</td></tr>
        </tbody>
      </table>

      <div class="hr"></div>

      <h3 style="margin:0 0 8px;">2) Personal Cashflow Statement (bulanan)</h3>
      <div class="small">Arus kas masuk dan keluar untuk menilai keberlanjutan bulanan.</div>
      <div class="hr"></div>

      <table class="tbl-2col-wideNum">
        <colgroup><col/><col/></colgroup>
        <thead><tr><th>Arus Kas</th><th>Jumlah</th></tr></thead>
        <tbody>
          <tr><td>Inflows (Income)</td><td id="cf_in" class="rightNum">-</td></tr>
          <tr><td>Outflows – Operating (Living)</td><td id="cf_op" class="rightNum">-</td></tr>
          <tr><td>Outflows – Financing (Debt pay)</td><td id="cf_fin" class="rightNum">-</td></tr>
          <tr><td>Outflows – Saving</td><td id="cf_save" class="rightNum">-</td></tr>
          <tr><td>Outflows – Investing</td><td id="cf_inv" class="rightNum">-</td></tr>
          <tr><td>Outflows – Protection (Premium)</td><td id="cf_prot" class="rightNum">-</td></tr>
          <tr><td>Outflows – Other commitments</td><td id="cf_other" class="rightNum">-</td></tr>
          <tr><td><b>Net Cashflow (True Cash Left)</b></td><td id="cf_net" class="rightNum">-</td></tr>
        </tbody>
      </table>
    </section>

    <div class="page-sep no-print" aria-hidden="true"></div>

    <!-- =======================
         PAGE 11: BALANCE SHEET
         ======================= -->
    <section class="page print-page" id="page_bs">
      <div class="pageHeader">
        <h2 style="margin:0;">Page 11 — Balance Sheet</h2>
      </div>
      <div class="hr"></div>

      <h3 style="margin:0 0 8px;">3) Personal Balance Sheet (saat ini)</h3>
      <div class="small">
        Posisi aset dan kewajiban saat ini untuk menghitung net worth.
      </div>
      <div class="hr"></div>

      <table class="tbl-2col-wideNum">
        <colgroup><col/><col/></colgroup>
        <thead><tr><th>Pos</th><th>Jumlah</th></tr></thead>
        <tbody>
          <tr><td colspan="2" class="small"><b>Assets</b></td></tr>
          <tr><td>Liquid assets</td><td id="bs_liquid" class="rightNum">-</td></tr>
          <tr><td>Investments</td><td id="bs_inv" class="rightNum">-</td></tr>
          <tr><td>Other assets</td><td id="bs_other" class="rightNum">-</td></tr>
          <tr><td><b>Total Assets</b></td><td id="bs_assets" class="rightNum">-</td></tr>

          <tr><td colspan="2" class="small"><b>Liabilities</b></td></tr>
          <tr><td>Short/high interest</td><td id="bs_short" class="rightNum">-</td></tr>
          <tr><td>Long term</td><td id="bs_long" class="rightNum">-</td></tr>
          <tr><td><b>Total Liabilities</b></td><td id="bs_liab" class="rightNum">-</td></tr>

          <tr><td colspan="2" class="small"><b>Equity</b></td></tr>
          <tr><td><b>Net Worth</b></td><td id="bs_nw" class="rightNum">-</td></tr>
        </tbody>
      </table>
    </section>

    <div class="page-sep no-print" aria-hidden="true"></div>

    <!-- =======================
         PAGE 12: REKOMENDASI
         ======================= -->
    <section class="page" id="page_rec">
      <div class="pageHeader">
        <h2 style="margin:0;">Page 12 — Rekomendasi Awal</h2>
      </div>
      <div class="hr"></div>

      <div class="small">Rekomendasi bersifat otomatis untuk bahan diskusi.</div>
      <ul id="next_steps" style="margin:10px 0 0; padding-left:18px; line-height:1.6;">
        <li>—</li>
      </ul>

      <details style="margin-top:12px;">
        <summary>Catatan fasilitator (internal)</summary>
        <div class="small" id="coach_notes" style="margin-top:10px; white-space:pre-wrap;">—</div>
      </details>
    </section>

  </div>
</div>

<!-- Bottom buttons (screen only) -->
<div class="actionBar no-print" role="toolbar" aria-label="Actions">
  <div class="actionInner">
    <div class="actionHint">PDF/Excel/Reset ada di bawah. Perhitungan otomatis.</div>
    <button class="btn" id="btn_pdf">Simpan sebagai PDF</button>
    <button class="btn" id="btn_excel">Export Excel</button>
    <button class="btn danger" id="btn_reset">Reset</button>
  </div>
</div>

<script src="https://cdn.jsdelivr.net/npm/xlsx@0.18.5/dist/xlsx.full.min.js"></script>
<script>
/* ========= Helpers ========= */
const IDR_FMT = new Intl.NumberFormat("id-ID", { maximumFractionDigits: 0 });
function toNumber(str){
  if (!str) return 0;
  const digits = String(str).replace(/[^\d]/g, "");
  return digits ? parseInt(digits, 10) : 0;
}
function fmtDigits(num){ return IDR_FMT.format(num); }
function fmtIDR(n){
  if (!Number.isFinite(n)) return "-";
  return new Intl.NumberFormat("id-ID", { style:"currency", currency:"IDR", maximumFractionDigits:0 }).format(n);
}
function pct(n){ return Number.isFinite(n) ? (n*100).toFixed(1) + "%" : "-"; }
function escapeHtml(str){
  return String(str ?? "")
    .replaceAll("&","&amp;").replaceAll("<","&lt;").replaceAll(">","&gt;")
    .replaceAll('"',"&quot;").replaceAll("'","&#039;");
}
function pill(elId, color, text){
  const el = document.getElementById(elId);
  el.className = "pill " + color;
  el.textContent = text;
}
function tag(color, text){
  return `<span class="tag ${color}">${escapeHtml(text)}</span>`;
}
function monthlyEquivalent(amount, period){
  const a = Number.isFinite(amount) ? amount : 0;
  return (period === "yearly") ? (a / 12) : a;
}

/* ========= Sections ========= */
const BASE_SECTIONS = [
  { key:"income", title:"Income (pemasukan)", desc:"Masukkan pemasukan. Item tahunan dihitung ÷ 12.", periodEnabled:true,
    rows:[
      { label:"Gaji bersih (take home)", amount:0, period:"monthly" },
      { label:"Side income", amount:0, period:"monthly" },
      { label:"Bonus/THR (jika ada)", amount:0, period:"yearly" }
    ],
    subtotalLabel:"Total Income (ekuivalen bulanan)"
  },
  { key:"needs", title:"Needs (kebutuhan pokok)", desc:"Pengeluaran penting/relatif wajib.", periodEnabled:true,
    rows:[
      { label:"Hunian (kos/sewa)", amount:0, period:"monthly" },
      { label:"Makan & groceries", amount:0, period:"monthly" },
      { label:"Transport", amount:0, period:"monthly" },
      { label:"Utilities (listrik/air/internet)", amount:0, period:"monthly" },
      { label:"Pulsa & langganan basic", amount:0, period:"monthly" },
      { label:"Kesehatan rutin", amount:0, period:"monthly" },
      { label:"Support keluarga/orang tua", amount:0, period:"monthly" },
      { label:"Donasi/zakat", amount:0, period:"monthly" },
      { label:"Biaya anak (jika ada)", amount:0, period:"monthly" },
      { label:"Biaya tahunan wajib (mis: pajak kendaraan)", amount:0, period:"yearly" }
    ],
    subtotalLabel:"Total Needs (ekuivalen bulanan)"
  },
  { key:"lifestyle", title:"Lifestyle (diskresi)", desc:"Pengeluaran pilihan/fleksibel.", periodEnabled:true,
    rows:[
      { label:"Jajan/ngopi", amount:0, period:"monthly" },
      { label:"Makan luar", amount:0, period:"monthly" },
      { label:"Hiburan", amount:0, period:"monthly" },
      { label:"Shopping", amount:0, period:"monthly" },
      { label:"Hobi/olahraga", amount:0, period:"monthly" },
      { label:"Liburan", amount:0, period:"yearly" }
    ],
    subtotalLabel:"Total Lifestyle (ekuivalen bulanan)"
  },
  { key:"commit", title:"Commitments & Allocations", desc:"Cicilan, premi, alokasi tabungan/investasi, dan komitmen lain.", periodEnabled:true,
    rows:[
      { label:"Cicilan total (debt payment)", amount:0, period:"monthly", tag:"debtpay" },
      { label:"Premi proteksi (jika bayar sendiri)", amount:0, period:"monthly", tag:"premium" },
      { label:"Tabungan rutin", amount:0, period:"monthly", tag:"saving" },
      { label:"Invest rutin", amount:0, period:"monthly", tag:"invest" },
      { label:"Komitmen lain (mis: arisan/iuran)", amount:0, period:"monthly", tag:"other" }
    ],
    subtotalLabel:"Total Commitments (ekuivalen bulanan)"
  },
  { key:"assets", title:"Assets (nilai saat ini)", desc:"Masukkan nilai aset saat ini (snapshot).", periodEnabled:false,
    rows:[
      { label:"Cash", amount:0, tag:"liquid" },
      { label:"Tabungan", amount:0, tag:"liquid" },
      { label:"RDPU / Deposito", amount:0, tag:"liquid" },
      { label:"Dana darurat terpisah", amount:0, tag:"liquid" },
      { label:"Reksa dana (non-RDPU)", amount:0, tag:"invest" },
      { label:"Saham/ETF", amount:0, tag:"invest" },
      { label:"Emas", amount:0, tag:"invest" },
      { label:"Crypto (opsional)", amount:0, tag:"invest" },
      { label:"Kendaraan (opsional)", amount:0, tag:"other" },
      { label:"Properti (opsional)", amount:0, tag:"other" }
    ],
    subtotalLabel:"Total Assets"
  },
  { key:"liabilities", title:"Liabilities (sisa pokok utang)", desc:"Masukkan sisa pokok utang (snapshot).", periodEnabled:false,
    rows:[
      { label:"KPR (sisa)", amount:0, tag:"long" },
      { label:"KKB (sisa)", amount:0, tag:"long" },
      { label:"KTA/Pinjol legal (sisa)", amount:0, tag:"short" },
      { label:"PayLater (sisa)", amount:0, tag:"short" },
      { label:"Kartu kredit (sisa)", amount:0, tag:"short" },
      { label:"Utang lain (sisa)", amount:0, tag:"short" }
    ],
    subtotalLabel:"Total Liabilities"
  }
];

const state = { sections: JSON.parse(JSON.stringify(BASE_SECTIONS)) };

/* ========= Render ========= */
function sectionCardHTML(sec){
  const perHint = sec.periodEnabled
    ? `<span class="small" style="margin-left:8px;">Untuk menambahkan item lain yang belum tertulis di atas.</span>`
    : `<span class="small" style="margin-left:8px;">Untuk menambahkan daftar lain yang belum tercantum di atas.</span>`;

  return `
    <div class="card" style="padding:12px;">
      <h3 style="margin:0;">${sec.title}</h3>
      <div class="small">${sec.desc}</div>
      <div class="hr"></div>

      <div class="twrap">
        <table>
          <thead>
            <tr>
              <th class="namecol">Item</th>
              <th class="percol">Periode</th>
              <th class="num">Jumlah</th>
            </tr>
          </thead>
          <tbody id="sec_${sec.key}_tbody"></tbody>
          <tbody>
            <tr class="subtotal subtotalRow">
              <td>${sec.subtotalLabel}</td>
              <td class="percol"></td>
              <td class="num"><span id="sec_${sec.key}_subtotal">-</span></td>
            </tr>
            <tr class="addrow addRowCard print-hide">
              <td colspan="3">
                <button class="btn small" data-add-row="${sec.key}">+ Tambah item</button>
                ${perHint}
              </td>
            </tr>
          </tbody>
        </table>
      </div>
    </div>
  `;
}

function rowHTML(sec, secKey, rowIndex, row){
  const rid = `row_${secKey}_${rowIndex}`;
  const labelId = `${rid}_label`;
  const amtId = `${rid}_amt`;
  const perId = `${rid}_per`;
  const removable = row._custom === true;

  const periodCell = sec.periodEnabled
    ? `<select id="${perId}" class="period">
         <option value="monthly" ${row.period==="monthly"?"selected":""}>Bulanan</option>
         <option value="yearly" ${row.period==="yearly"?"selected":""}>Tahunan</option>
       </select>`
    : `<select id="${perId}" class="period" disabled>
         <option value="now" selected>Saat ini</option>
       </select>`;

  const itemCell = removable
    ? `
      <div class="itemRow">
        <div class="itemGrow">
          <input id="${labelId}" value="${escapeHtml(row.label)}" placeholder="Nama item (contoh: Servis kendaraan)" />
        </div>
        <div class="rmWrap">
          <button class="btn icon danger" title="Hapus item" data-remove="${rid}">✕</button>
        </div>
      </div>
    `
    : `<div><b>${escapeHtml(row.label)}</b></div>`;

  return `
    <tr data-row="${rid}">
      <td data-label="Item">${itemCell}</td>
      <td class="percol" data-label="Periode">${periodCell}</td>
      <td class="num" data-label="Jumlah">
        <input id="${amtId}" class="money" inputmode="numeric" placeholder="0"
               value="${row.amount ? fmtDigits(row.amount) : ""}" />
      </td>
    </tr>
  `;
}

function renderSectionRows(secKey){
  const sec = state.sections.find(x => x.key === secKey);
  const tbody = document.getElementById(`sec_${secKey}_tbody`);
  tbody.innerHTML = sec.rows.map((r, idx) => rowHTML(sec, secKey, idx, r)).join("");

  // bind remove buttons for custom rows
  tbody.querySelectorAll("[data-remove]").forEach(btn=>{
    btn.addEventListener("click", ()=>{
      const rid = btn.dataset.remove; // row_sec_idx
      const parts = rid.split("_");
      const sk = parts[1];
      const idx = parseInt(parts[2],10);
      removeRow(sk, idx);
    });
  });
}

function mountSections(){
  const m = (key) => document.getElementById(`sec_mount_${key}`);
  const byKey = (key) => state.sections.find(s=>s.key===key);

  const mountOne = (key)=>{
    const el = m(key);
    if (!el) return;
    el.innerHTML = sectionCardHTML(byKey(key));
    renderSectionRows(key);
    el.querySelector(`[data-add-row="${key}"]`)?.addEventListener("click", ()=> addCustomRow(key));
  };

  ["income","needs","lifestyle","commit","assets","liabilities"].forEach(mountOne);

  bindHandlers();
  recalcAll();
}

function addCustomRow(secKey){
  const sec = state.sections.find(x => x.key === secKey);
  // default: monthly for periodEnabled sections, else snapshot
  if (sec.periodEnabled){
    sec.rows.push({ label:"", amount:0, period:"monthly", _custom:true });
  } else {
    sec.rows.push({ label:"", amount:0, _custom:true });
  }
  renderSectionRows(secKey);
  bindHandlers();
  recalcAll();
}
function removeRow(secKey, idx){
  const sec = state.sections.find(x => x.key === secKey);
  sec.rows.splice(idx, 1);
  renderSectionRows(secKey);
  bindHandlers();
  recalcAll();
}

/* ========= Bind handlers (auto compute) ========= */
function bindHandlers(){
  // money inputs
  document.querySelectorAll("input.money").forEach(el=>{
    if (el.dataset.bound === "1") return;
    el.dataset.bound = "1";
    el.addEventListener("input", ()=>{
      const raw = toNumber(el.value);
      el.value = raw === 0 ? "" : fmtDigits(raw);
      recalcAll();
    });
    el.addEventListener("blur", ()=>{
      const raw = toNumber(el.value);
      el.value = raw === 0 ? "" : fmtDigits(raw);
      recalcAll();
    });
  });

  // period dropdowns
  document.querySelectorAll("select.period").forEach(el=>{
    if (el.dataset.bound === "1") return;
    el.dataset.bound = "1";
    el.addEventListener("change", ()=>{
      const id = el.id; // row_sec_idx_per
      const m = id.match(/^row_(.+)_(\d+)_per$/);
      if (!m) return;
      const secKey = m[1];
      const idx = parseInt(m[2],10);
      const sec = state.sections.find(x=>x.key===secKey);
      if (!sec || !sec.periodEnabled) return;
      sec.rows[idx].period = el.value;
      recalcAll();
    });
  });

  // custom label inputs
  document.querySelectorAll('tbody input:not(.money)').forEach(el=>{
    if (el.dataset.bound === "1") return;
    el.dataset.bound = "1";
    el.addEventListener("input", ()=>{
      const id = el.id;
      const m = id.match(/^row_(.+)_(\d+)_label$/);
      if (!m) return;
      const secKey = m[1];
      const idx = parseInt(m[2],10);
      const sec = state.sections.find(x=>x.key===secKey);
      if (!sec) return;
      sec.rows[idx].label = el.value || "";
    });
  });

  // profile inputs (auto compute too)
  ["pf_name","pf_status","pf_dependents","pf_ef_target","pf_worry","pf_next12m"].forEach(id=>{
    const el = document.getElementById(id);
    if (!el || el.dataset.bound === "1") return;
    el.dataset.bound = "1";
    el.addEventListener("input", ()=> recalcAll());
    el.addEventListener("change", ()=> recalcAll());
  });

  // dependents digits only
  const dep = document.getElementById("pf_dependents");
  if (dep && dep.dataset.bound2 !== "1"){
    dep.dataset.bound2 = "1";
    dep.addEventListener("input", ()=>{
      dep.value = String(dep.value || "").replace(/[^\d]/g,"");
      recalcAll();
    });
  }
}

/* ========= Calculations ========= */
function sumSectionMonthly(secKey){
  const sec = state.sections.find(x => x.key === secKey);
  let totalMonthly = 0;

  sec.rows.forEach((row, idx)=>{
    const amtEl = document.getElementById(`row_${secKey}_${idx}_amt`);
    const rawAmount = amtEl ? toNumber(amtEl.value) : (row.amount || 0);
    row.amount = rawAmount;

    if (sec.periodEnabled){
      const perEl = document.getElementById(`row_${secKey}_${idx}_per`);
      const period = perEl ? perEl.value : (row.period || "monthly");
      row.period = period;
      totalMonthly += monthlyEquivalent(rawAmount, period);
    } else {
      totalMonthly += rawAmount;
    }
  });

  return totalMonthly;
}
function subtotalRender(secKey, total){
  const el = document.getElementById(`sec_${secKey}_subtotal`);
  if (el) el.textContent = fmtIDR(total);
}
function setBlock(id, html){
  const el = document.getElementById(id);
  if (!el) return;
  const target = el.querySelector(".kpiText");
  if (target) target.innerHTML = html;
}
function severityTag(level){
  if (level === "red") return tag("red","Risiko tinggi");
  if (level === "yellow") return tag("yellow","Perlu perhatian");
  if (level === "green") return tag("green","Relatif sehat");
  return tag("","Informasi");
}

let latestComputed = null;

function recalcAll(){
  const incomeM = sumSectionMonthly("income");
  const needsM  = sumSectionMonthly("needs");
  const lifeM   = sumSectionMonthly("lifestyle");
  const commitM = sumSectionMonthly("commit");
  const assetsTotal = sumSectionMonthly("assets");
  const liabTotal   = sumSectionMonthly("liabilities");

  subtotalRender("income", incomeM);
  subtotalRender("needs", needsM);
  subtotalRender("lifestyle", lifeM);
  subtotalRender("commit", commitM);
  subtotalRender("assets", assetsTotal);
  subtotalRender("liabilities", liabTotal);

  const livingM = needsM + lifeM;

  // Commit breakdown by tag (monthly-equivalent)
  const commitSec = state.sections.find(x=>x.key==="commit");
  const commitMonthlyByTag = (tagName) => {
    const row = commitSec.rows.find(r=>r.tag===tagName);
    if (!row) return 0;
    const period = row.period || "monthly";
    return monthlyEquivalent(row.amount||0, period);
  };
  const debtPayM = commitMonthlyByTag("debtpay");
  const premiumM = commitMonthlyByTag("premium");
  const savingM  = commitMonthlyByTag("saving");
  const investM  = commitMonthlyByTag("invest");
  const otherCommitM = commitMonthlyByTag("other");

  // Assets breakdown
  const assetsSec = state.sections.find(x=>x.key==="assets");
  const sumAssetsByTag = (t)=> assetsSec.rows.filter(r=>r.tag===t).reduce((a,b)=>a+(b.amount||0),0);
  const liquidAssets = sumAssetsByTag("liquid");
  const invAssets = sumAssetsByTag("invest");
  const otherAssets = sumAssetsByTag("other");

  // Liabilities breakdown
  const liabSec = state.sections.find(x=>x.key==="liabilities");
  const shortLiab = liabSec.rows.filter(r=>r.tag==="short").reduce((a,b)=>a+(b.amount||0),0);
  const longLiab  = liabSec.rows.filter(r=>r.tag==="long").reduce((a,b)=>a+(b.amount||0),0);

  const netBeforeAlloc = incomeM - livingM - debtPayM - premiumM;
  const trueCashLeft   = incomeM - livingM - debtPayM - premiumM - savingM - investM - otherCommitM;
  const netWorth = assetsTotal - liabTotal;

  const efTarget = parseFloat(document.getElementById("pf_ef_target").value || "3");
  const efBase = needsM;
  const efMonths = efBase > 0 ? (liquidAssets / efBase) : NaN;

  const saveRate = incomeM > 0 ? ((savingM + investM) / incomeM) : NaN;
  const debtRatio = incomeM > 0 ? (debtPayM / incomeM) : NaN;
  const liquidityMonths = (livingM + debtPayM + premiumM) > 0 ? (liquidAssets / (livingM + debtPayM + premiumM)) : NaN;

  latestComputed = {
    incomeM, needsM, lifeM, livingM, debtPayM, premiumM, savingM, investM, otherCommitM,
    assetsTotal, liabTotal, netBeforeAlloc, trueCashLeft, netWorth,
    liquidAssets, invAssets, otherAssets, shortLiab, longLiab,
    efTarget, efMonths, saveRate, debtRatio, liquidityMonths
  };

  // KPI numbers
  document.getElementById("k_income").textContent = fmtIDR(incomeM);
  document.getElementById("k_living").textContent = fmtIDR(livingM);
  document.getElementById("k_debtpay").textContent = fmtIDR(debtPayM);
  document.getElementById("k_saveinvest").textContent = fmtIDR(savingM + investM);
  document.getElementById("k_cashleft").textContent = fmtIDR(trueCashLeft);
  document.getElementById("k_ef").textContent = Number.isFinite(efMonths) ? efMonths.toFixed(1) + " bulan" : "-";
  document.getElementById("k_nw").textContent = fmtIDR(netWorth);

  document.getElementById("r_save").textContent = pct(saveRate);
  document.getElementById("r_debt").textContent = pct(debtRatio);
  document.getElementById("r_liq").textContent = Number.isFinite(liquidityMonths) ? liquidityMonths.toFixed(1) + " bln" : "-";

  // Overall
  let red = 0, yellow = 0;
  if (trueCashLeft < 0) red++; else if (incomeM>0 && trueCashLeft < incomeM*0.05) yellow++;
  if (debtRatio > 0.40) red++; else if (debtRatio > 0.30) yellow++;
  if (Number.isFinite(efMonths) && efMonths < 1) red++; else if (Number.isFinite(efMonths) && efMonths < efTarget) yellow++;

  let overallLevel = "gray";
  if (incomeM === 0 && (livingM>0 || commitM>0)) overallLevel = "yellow";
  else if (red >= 2) overallLevel = "red";
  else if (red === 1 || yellow >= 2) overallLevel = "yellow";
  else overallLevel = "green";

  if (overallLevel === "yellow" && incomeM === 0){
    pill("pill_overall","yellow","Belum lengkap");
    document.getElementById("overall_text").textContent = "Income masih 0. Silakan isi income agar hasil analisis akurat.";
  } else if (overallLevel === "red"){
    pill("pill_overall","red","Perlu perhatian");
    document.getElementById("overall_text").textContent =
      "Terdapat beberapa indikator berisiko. Prioritas awal: stabilkan arus kas dan kendalikan kewajiban.";
  } else if (overallLevel === "yellow"){
    pill("pill_overall","yellow","Perlu perapihan");
    document.getElementById("overall_text").textContent =
      "Kondisi dasar terbentuk, namun masih terdapat area yang perlu distabilkan agar kapasitas menabung meningkat.";
  } else {
    pill("pill_overall","green","Relatif sehat");
    document.getElementById("overall_text").textContent =
      "Kondisi relatif stabil. Fokus berikutnya: meningkatkan konsistensi tabungan/investasi dan penyusunan goals.";
  }

  // Detailed interpretation
  const livingPct = incomeM>0 ? livingM/incomeM : NaN;
  const needsPct = incomeM>0 ? needsM/incomeM : NaN;
  const lifePct = incomeM>0 ? lifeM/incomeM : NaN;

  const overviewLines = [];
  overviewLines.push(`<div><b>Ringkasan kondisi:</b> ${severityTag(overallLevel)}.</div>`);
  overviewLines.push(`<div>Income ekuivalen bulanan: <b>${fmtIDR(incomeM)}</b>.</div>`);
  overviewLines.push(`<div>Biaya hidup: <b>${fmtIDR(livingM)}</b>${incomeM>0?` (${(livingPct*100).toFixed(1)}% dari income)`:""}.</div>`);
  overviewLines.push(`<div>Cicilan: <b>${fmtIDR(debtPayM)}</b>${incomeM>0?` (${(debtRatio*100).toFixed(1)}% dari income)`:""}.</div>`);
  overviewLines.push(`<div>Saving+Invest: <b>${fmtIDR(savingM+investM)}</b>${incomeM>0?` (${(saveRate*100).toFixed(1)}% dari income)`:""}.</div>`);
  overviewLines.push(`<div>True Cash Left: <b>${fmtIDR(trueCashLeft)}</b>.</div>`);
  document.getElementById("detail_overview").innerHTML = `<div class="small">${overviewLines.join("")}</div>`;

  // A Cashflow
  let cfLevel = "green";
  if (trueCashLeft < 0) cfLevel = "red";
  else if (incomeM>0 && trueCashLeft < incomeM*0.05) cfLevel = "yellow";
  const cfText = [];
  cfText.push(`${severityTag(cfLevel)}. `);
  if (cfLevel==="red"){
    cfText.push(`Arus kas bulanan defisit. Umumnya menyebabkan penggunaan tabungan untuk kebutuhan rutin atau peningkatan utang konsumtif.`);
    cfText.push(`<br><b>Implikasi:</b> goals sulit tercapai sampai defisit ditutup.`);
  } else if (cfLevel==="yellow"){
    cfText.push(`Arus kas masih positif namun tipis. Rentan terganggu oleh pengeluaran mendadak.`);
    cfText.push(`<br><b>Implikasi:</b> perlu buffer dan disiplin alokasi.`);
  } else {
    cfText.push(`Arus kas positif dan memadai. Ini fondasi untuk meningkatkan saving/invest dan menyusun goals.`);
  }
  cfText.push(`<br><b>Angka kunci:</b> Net sebelum saving+invest = ${fmtIDR(netBeforeAlloc)}; True Cash Left = ${fmtIDR(trueCashLeft)}.`);
  setBlock("detail_cashflow", cfText.join(" "));

  // B Spending
  let spLevel = "green";
  if (Number.isFinite(livingPct) && livingPct > 0.85) spLevel = "red";
  else if (Number.isFinite(livingPct) && livingPct > 0.70) spLevel = "yellow";
  const spText = [];
  spText.push(`${severityTag(spLevel)}. `);
  if (!Number.isFinite(livingPct)){
    spText.push(`Rasio pengeluaran belum dapat dihitung karena income belum diisi.`);
  } else {
    spText.push(`Komposisi: Needs ${fmtIDR(needsM)} (${(needsPct*100).toFixed(1)}%), Lifestyle ${fmtIDR(lifeM)} (${(lifePct*100).toFixed(1)}%).`);
    if (spLevel==="red"){
      spText.push(`<br><b>Catatan:</b> biaya hidup menyerap mayoritas income. Ruang tabungan/invest dan goals terbatas kecuali ada penyesuaian.`);
    } else if (spLevel==="yellow"){
      spText.push(`<br><b>Catatan:</b> biaya hidup cukup besar. Optimasi lifestyle dan biaya tahunan biasanya efektif.`);
    } else {
      spText.push(`<br><b>Catatan:</b> biaya hidup relatif terkendali. Fokus dapat beralih ke peningkatan saving rate dan goals.`);
    }
  }
  setBlock("detail_spending", spText.join(" "));

  // C Debt
  let dbLevel = "green";
  if (debtRatio > 0.40) dbLevel = "red";
  else if (debtRatio > 0.30) dbLevel = "yellow";
  const dbText = [];
  dbText.push(`${severityTag(dbLevel)}. `);
  if (!Number.isFinite(debtRatio)){
    dbText.push(`Rasio cicilan belum dapat dihitung karena income belum diisi.`);
  } else {
    dbText.push(`Cicilan = ${fmtIDR(debtPayM)} (${(debtRatio*100).toFixed(1)}% dari income).`);
    dbText.push(`<br>Snapshot utang: short/high interest ${fmtIDR(shortLiab)}, long term ${fmtIDR(longLiab)}.`);
    if (dbLevel==="red"){
      dbText.push(`<br><b>Implikasi:</b> risiko tekanan arus kas tinggi. Prioritas pelunasan utang berbunga tinggi disarankan.`);
    } else if (dbLevel==="yellow"){
      dbText.push(`<br><b>Implikasi:</b> tetap kendalikan penambahan kewajiban baru agar saving capacity tidak tergerus.`);
    } else {
      dbText.push(`<br><b>Implikasi:</b> beban cicilan relatif aman. Kapasitas saving/invest dapat dioptimalkan.`);
    }
  }
  setBlock("detail_debt", dbText.join(" "));

  // D Saving
  let svLevel = "green";
  if (Number.isFinite(saveRate) && saveRate < 0.05) svLevel = "red";
  else if (Number.isFinite(saveRate) && saveRate < 0.10) svLevel = "yellow";
  const svText = [];
  svText.push(`${severityTag(svLevel)}. `);
  if (!Number.isFinite(saveRate)){
    svText.push(`Saving rate belum dapat dihitung karena income belum diisi.`);
  } else {
    svText.push(`Saving+Invest = ${fmtIDR(savingM+investM)} (${(saveRate*100).toFixed(1)}% dari income).`);
    if (svLevel==="red"){
      svText.push(`<br><b>Catatan:</b> kapasitas sangat terbatas. Perlu perbaikan cashflow atau pengurangan beban biaya/cicilan.`);
    } else if (svLevel==="yellow"){
      svText.push(`<br><b>Catatan:</b> kapasitas ada namun masih rendah. Kenaikan bertahap biasanya lebih berkelanjutan.`);
    } else {
      svText.push(`<br><b>Catatan:</b> kapasitas relatif baik. Langkah berikut: menetapkan goals dan strategi instrumen sesuai horizon.`);
    }
  }
  setBlock("detail_saving", svText.join(" "));

  // E EF
  let efLevel = "green";
  if (Number.isFinite(efMonths) && efMonths < 1) efLevel = "red";
  else if (Number.isFinite(efMonths) && efMonths < efTarget) efLevel = "yellow";
  const efText = [];
  efText.push(`${severityTag(efLevel)}. `);
  if (!Number.isFinite(efMonths)){
    efText.push(`Emergency buffer belum dapat dihitung (biasanya karena Needs masih 0).`);
  } else {
    efText.push(`Dana likuid ${fmtIDR(liquidAssets)}; buffer ${efMonths.toFixed(1)} bulan (target ${efTarget} bulan, basis Needs).`);
    if (efLevel==="red"){
      efText.push(`<br><b>Implikasi:</b> ketahanan rendah terhadap kejadian tak terduga. Prioritas utama membangun minimal 1 bulan terlebih dahulu.`);
    } else if (efLevel==="yellow"){
      efText.push(`<br><b>Implikasi:</b> ketahanan sudah ada namun belum sesuai target. Peningkatan bertahap disarankan.`);
    } else {
      efText.push(`<br><b>Implikasi:</b> ketahanan darurat memadai. Fokus dapat dialihkan ke goals/investasi terarah.`);
    }
  }
  setBlock("detail_ef", efText.join(" "));

  // F Balance
  const nwLevel = (netWorth < 0) ? "yellow" : "green";
  const blText = [];
  blText.push(`${severityTag(nwLevel)}. `);
  blText.push(`Aset ${fmtIDR(assetsTotal)} (Likuid ${fmtIDR(liquidAssets)}, Invest ${fmtIDR(invAssets)}, Lainnya ${fmtIDR(otherAssets)}).`);
  blText.push(`<br>Kewajiban ${fmtIDR(liabTotal)} (Short ${fmtIDR(shortLiab)}, Long ${fmtIDR(longLiab)}).`);
  blText.push(`<br><b>Net Worth</b> = ${fmtIDR(netWorth)}.`);
  blText.push(`<br><b>Catatan:</b> Net worth negatif dapat terjadi pada fase awal KPR, namun tetap perlu disiplin arus kas dan strategi akumulasi aset.`);
  setBlock("detail_balance", blText.join(" "));

  // Next steps
  const steps = [];
  if (trueCashLeft < 0) steps.push("Menutup defisit arus kas sebagai prioritas utama (optimasi lifestyle dan biaya tahunan; hindari penambahan kewajiban baru).");
  if (debtRatio > 0.35) steps.push("Menyusun strategi pengendalian cicilan: fokus pelunasan utang berbunga tinggi, evaluasi refinancing bila relevan.");
  if (Number.isFinite(efMonths) && efMonths < 1) steps.push("Membangun dana darurat minimal 1 bulan kebutuhan pokok, kemudian bertahap menuju target 3–6 bulan.");
  else if (Number.isFinite(efMonths) && efMonths < efTarget) steps.push(`Meningkatkan dana darurat secara bertahap hingga mencapai ${efTarget} bulan kebutuhan pokok.`);
  if (Number.isFinite(saveRate) && saveRate < 0.10 && trueCashLeft > 0) steps.push("Meningkatkan saving rate menuju minimal 10% melalui auto-transfer setelah gajian.");
  if (steps.length === 0) steps.push("Menetapkan goals prioritas (6–18 bulan) dan merancang alokasi tabungan/invest sesuai horizon waktu.");
  document.getElementById("next_steps").innerHTML = steps.map(x=>`<li>${escapeHtml(x)}</li>`).join("");

  // Coach notes
  const name = document.getElementById("pf_name").value || "-";
  const dep = document.getElementById("pf_dependents").value || "0";
  const status = document.getElementById("pf_status").value;
  const worry = document.getElementById("pf_worry").value || "";
  const next12 = document.getElementById("pf_next12m").value || "";
  const coach = [];
  coach.push(`Nama: ${name} | Status: ${status} | Tanggungan: ${dep}`);
  coach.push(`Income(M): ${fmtIDR(incomeM)} | Living(M): ${fmtIDR(livingM)} | DebtPay(M): ${fmtIDR(debtPayM)} | Premium(M): ${fmtIDR(premiumM)}`);
  coach.push(`Saving+Invest(M): ${fmtIDR(savingM+investM)} | OtherCommit(M): ${fmtIDR(otherCommitM)} | TrueCashLeft(M): ${fmtIDR(trueCashLeft)}`);
  coach.push(`Liquid: ${fmtIDR(liquidAssets)} | EF months: ${Number.isFinite(efMonths)?efMonths.toFixed(1):"-"} | Target: ${efTarget} bln`);
  coach.push(`Assets: ${fmtIDR(assetsTotal)} | Liab: ${fmtIDR(liabTotal)} | NetWorth: ${fmtIDR(netWorth)}`);
  if (worry) coach.push(`Isu: ${worry}`);
  if (next12) coach.push(`Rencana 12 bulan: ${next12}`);
  document.getElementById("coach_notes").textContent = coach.join("\n");

  // Statements
  const pctOfIncome = (amt) => incomeM>0 ? pct(amt/incomeM) : "-";
  document.getElementById("is_income").textContent = fmtIDR(incomeM);
  document.getElementById("is_income_pct").textContent = incomeM>0 ? "100%" : "-";
  document.getElementById("is_needs").textContent = fmtIDR(needsM);
  document.getElementById("is_needs_pct").textContent = pctOfIncome(needsM);
  document.getElementById("is_life").textContent = fmtIDR(lifeM);
  document.getElementById("is_life_pct").textContent = pctOfIncome(lifeM);
  document.getElementById("is_living").textContent = fmtIDR(livingM);
  document.getElementById("is_living_pct").textContent = pctOfIncome(livingM);
  document.getElementById("is_debt").textContent = fmtIDR(debtPayM);
  document.getElementById("is_debt_pct").textContent = pctOfIncome(debtPayM);
  document.getElementById("is_prem").textContent = fmtIDR(premiumM);
  document.getElementById("is_prem_pct").textContent = pctOfIncome(premiumM);
  document.getElementById("is_net").textContent = fmtIDR(netBeforeAlloc);
  document.getElementById("is_net_pct").textContent = pctOfIncome(netBeforeAlloc);
  document.getElementById("is_save").textContent = fmtIDR(savingM);
  document.getElementById("is_save_pct").textContent = pctOfIncome(savingM);
  document.getElementById("is_inv").textContent = fmtIDR(investM);
  document.getElementById("is_inv_pct").textContent = pctOfIncome(investM);

  document.getElementById("cf_in").textContent = fmtIDR(incomeM);
  document.getElementById("cf_op").textContent = fmtIDR(livingM);
  document.getElementById("cf_fin").textContent = fmtIDR(debtPayM);
  document.getElementById("cf_save").textContent = fmtIDR(savingM);
  document.getElementById("cf_inv").textContent = fmtIDR(investM);
  document.getElementById("cf_prot").textContent = fmtIDR(premiumM);
  document.getElementById("cf_other").textContent = fmtIDR(otherCommitM);
  document.getElementById("cf_net").textContent = fmtIDR(trueCashLeft);

  document.getElementById("bs_liquid").textContent = fmtIDR(liquidAssets);
  document.getElementById("bs_inv").textContent = fmtIDR(invAssets);
  document.getElementById("bs_other").textContent = fmtIDR(otherAssets);
  document.getElementById("bs_assets").textContent = fmtIDR(assetsTotal);
  document.getElementById("bs_short").textContent = fmtIDR(shortLiab);
  document.getElementById("bs_long").textContent = fmtIDR(longLiab);
  document.getElementById("bs_liab").textContent = fmtIDR(liabTotal);
  document.getElementById("bs_nw").textContent = fmtIDR(netWorth);
}

/* ========= Export PDF ========= */
function saveAsPDF(){
  recalcAll();
  document.querySelectorAll("details").forEach(d=> d.open = true);
  window.print();
}

/* ========= Export Excel ========= */
function getProfile(){
  return {
    name: document.getElementById("pf_name").value || "",
    status: document.getElementById("pf_status").value || "",
    dependents: document.getElementById("pf_dependents").value || "",
    ef_target: document.getElementById("pf_ef_target").value || "",
    worry: document.getElementById("pf_worry").value || "",
    next12m: document.getElementById("pf_next12m").value || ""
  };
}
function collectRowsForExport(){
  const rows = [];
  for (const sec of state.sections){
    sec.rows.forEach((r)=>{
      const amount = r.amount || 0;
      const period = sec.periodEnabled ? (r.period || "monthly") : "now";
      const monthlyEq = sec.periodEnabled ? monthlyEquivalent(amount, period) : amount;
      rows.push({
        section: sec.title,
        item: r.label || "",
        period: sec.periodEnabled ? (period === "yearly" ? "Tahunan" : "Bulanan") : "Saat ini",
        amount_raw: amount,
        monthly_equivalent: monthlyEq,
      });
    });
  }
  return rows;
}
function exportExcel(){
  recalcAll();
  if (typeof XLSX === "undefined") {
    alert("Library XLSX belum termuat. Pastikan script SheetJS sudah ditambahkan (xlsx.full.min.js).");
    return;
  }

  const p = getProfile();
  const c = latestComputed || {};
  const now = new Date();
  const dateStr = now.toISOString().slice(0,10);

  // Sheet 1: INPUT
  const inputAoA = [
    ["Personal/Family Financial Health Check - INPUT"],
    ["Generated date", dateStr],
    [],
    ["Nama/Inisial", p.name || ""],
    ["Status", p.status || ""],
    ["Tanggungan", p.dependents || ""],
    ["Target Dana Darurat (bulan)", p.ef_target || ""],
    [],
    ["Section", "Item", "Periode", "Jumlah (input)", "Ekuivalen Bulanan", "Catatan"]
  ];

  const inputRows = collectRowsForExport().map(r => ([
    r.section, r.item, r.period, (r.amount_raw||0), Math.round(r.monthly_equivalent||0), ""
  ]));
  inputAoA.push(...inputRows);

  const wsInput = XLSX.utils.aoa_to_sheet(inputAoA);
  wsInput["!cols"] = [{wch:28},{wch:40},{wch:12},{wch:18},{wch:20},{wch:30}];

  const headerRowIdx = inputAoA.findIndex(r => r[0] === "Section"); // 0-based
  const startRow = headerRowIdx + 2; // 1-based excel rows
  const endRow = startRow + inputRows.length - 1;
  for (let r = startRow; r <= endRow; r++){
    const addrD = XLSX.utils.encode_cell({ r: r-1, c: 3 });
    const addrE = XLSX.utils.encode_cell({ r: r-1, c: 4 });
    if (wsInput[addrD]) wsInput[addrD].z = '#,##0';
    if (wsInput[addrE]) wsInput[addrE].z = '#,##0';
  }

  // Sheet 2: SUMMARY
  const summaryAoA = [
    ["Personal/Family Financial Health Check - SUMMARY"],
    ["Generated date", dateStr],
    [],
    ["Nama/Inisial", p.name || ""],
    ["Status", p.status || ""],
    ["Tanggungan", p.dependents || ""],
    ["Target Dana Darurat (bulan)", p.ef_target || ""],
    [],
    ["Ringkasan Bulanan", "Nilai"],
    ["Total Income (bulanan)", Math.round(c.incomeM || 0)],
    ["Needs (bulanan)", Math.round(c.needsM || 0)],
    ["Lifestyle (bulanan)", Math.round(c.lifeM || 0)],
    ["Living Expenses (Needs+Lifestyle)", Math.round(c.livingM || 0)],
    ["Debt Payment (cicilan)", Math.round(c.debtPayM || 0)],
    ["Premium (proteksi)", Math.round(c.premiumM || 0)],
    ["Saving (alokasi)", Math.round(c.savingM || 0)],
    ["Invest (alokasi)", Math.round(c.investM || 0)],
    ["Other commitments", Math.round(c.otherCommitM || 0)],
    ["True Cash Left", Math.round(c.trueCashLeft || 0)],
    ["Net sebelum saving+invest", Math.round(c.netBeforeAlloc || 0)],
    [],
    ["Balance Sheet Snapshot", "Nilai"],
    ["Liquid assets", Math.round(c.liquidAssets || 0)],
    ["Investments", Math.round(c.invAssets || 0)],
    ["Other assets", Math.round(c.otherAssets || 0)],
    ["Total Assets", Math.round(c.assetsTotal || 0)],
    ["Short / high-interest liabilities", Math.round(c.shortLiab || 0)],
    ["Long-term liabilities", Math.round(c.longLiab || 0)],
    ["Total Liabilities", Math.round(c.liabTotal || 0)],
    ["Net Worth", Math.round(c.netWorth || 0)],
    [],
    ["Key Ratios", "Nilai"],
    ["Saving rate", Number.isFinite(c.saveRate) ? c.saveRate : ""],
    ["Debt ratio", Number.isFinite(c.debtRatio) ? c.debtRatio : ""],
    ["Liquidity months", Number.isFinite(c.liquidityMonths) ? c.liquidityMonths : ""],
    ["Emergency buffer months", Number.isFinite(c.efMonths) ? c.efMonths : ""],
  ];
  const wsSummary = XLSX.utils.aoa_to_sheet(summaryAoA);
  wsSummary["!cols"] = [{wch:44},{wch:22}];
  for (let r = 0; r < summaryAoA.length; r++){
    const val = summaryAoA[r][1];
    const addr = XLSX.utils.encode_cell({ r, c: 1 });
    if (!wsSummary[addr]) continue;
    if (summaryAoA[r][0] === "Saving rate" || summaryAoA[r][0] === "Debt ratio"){
      wsSummary[addr].z = '0.0%';
      wsSummary[addr].v = Number.isFinite(val) ? val : "";
      continue;
    }
    if (String(summaryAoA[r][0] || "").toLowerCase().includes("months")){
      wsSummary[addr].z = '0.0';
      continue;
    }
    if (typeof val === "number") wsSummary[addr].z = '#,##0';
  }

  // Sheet 3: REKOMENDASI
  const recList = Array.from(document.querySelectorAll("#next_steps li"))
    .map(li => (li.textContent || "").trim())
    .filter(Boolean);

  const overall = (document.getElementById("pill_overall")?.textContent || "-").trim();
  const overallText = (document.getElementById("overall_text")?.textContent || "").trim();

  const detailTexts = {
    overview: (document.getElementById("detail_overview")?.innerText || "").trim(),
    cashflow: (document.getElementById("detail_cashflow")?.innerText || "").trim(),
    spending: (document.getElementById("detail_spending")?.innerText || "").trim(),
    debt: (document.getElementById("detail_debt")?.innerText || "").trim(),
    saving: (document.getElementById("detail_saving")?.innerText || "").trim(),
    ef: (document.getElementById("detail_ef")?.innerText || "").trim(),
    balance: (document.getElementById("detail_balance")?.innerText || "").trim(),
  };

  const recAoA = [
    ["Personal/Family Financial Health Check - REKOMENDASI"],
    ["Generated date", dateStr],
    [],
    ["Ringkasan status", overall],
    ["Penjelasan status", overallText],
    [],
    ["Rekomendasi (otomatis)"],
    ... (recList.length ? recList.map((t,i)=>[`${i+1}.`, t]) : [["-", "Belum ada rekomendasi. Isi data lalu ringkasan akan muncul otomatis."]]),
    [],
    ["Catatan Peserta (opsional)"],
    ["Isu utama yang dirasakan", p.worry || ""],
    ["Rencana/peristiwa 12 bulan ke depan", p.next12m || ""],
    [],
    ["Interpretasi Detail (ringkasan)"],
    ["Overview", detailTexts.overview],
    ["A. Stabilitas Arus Kas", detailTexts.cashflow],
    ["B. Struktur Pengeluaran", detailTexts.spending],
    ["C. Beban Cicilan", detailTexts.debt],
    ["D. Kapasitas Menabung & Investasi", detailTexts.saving],
    ["E. Dana Darurat & Likuiditas", detailTexts.ef],
    ["F. Posisi Kekayaan Bersih", detailTexts.balance],
  ];
  const wsRec = XLSX.utils.aoa_to_sheet(recAoA);
  wsRec["!cols"] = [{wch:32},{wch:90}];

  const wb = XLSX.utils.book_new();
  XLSX.utils.book_append_sheet(wb, wsInput, "Input");
  XLSX.utils.book_append_sheet(wb, wsSummary, "Summary");
  XLSX.utils.book_append_sheet(wb, wsRec, "Rekomendasi");

  const fileNameBase = (p.name ? `health_check_${p.name}` : "health_check");
  XLSX.writeFile(wb, `${fileNameBase}_${dateStr}.xlsx`);
}

/* ========= Reset ========= */
document.getElementById("btn_reset").addEventListener("click", ()=>{
  if (!confirm("Reset semua data?")) return;
  state.sections = JSON.parse(JSON.stringify(BASE_SECTIONS));
  document.getElementById("pf_name").value = "";
  document.getElementById("pf_status").value = "single";
  document.getElementById("pf_dependents").value = "";
  document.getElementById("pf_ef_target").value = "3";
  document.getElementById("pf_worry").value = "";
  document.getElementById("pf_next12m").value = "";
  mountSections();
  pill("pill_overall","gray","-");
  document.getElementById("overall_text").textContent = "Silakan isi data, lalu lihat ringkasan hasilnya.";
});

/* ========= Buttons ========= */
document.getElementById("btn_pdf").addEventListener("click", saveAsPDF);
document.getElementById("btn_excel").addEventListener("click", exportExcel);

/* ========= Init ========= */
(function init(){
  mountSections();
})();
</script>

<script>
  window.va = window.va || function () { (window.vaq = window.vaq || []).push(arguments); };
</script>
<script defer src="/_vercel/insights/script.js"></script>
</body>
</html>
